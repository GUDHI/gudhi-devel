jobs:
  
  - job: 'OSx'
    displayName: "Build and test OSx"
    timeoutInMinutes: 0
    cancelTimeoutInMinutes: 60
    pool:
      vmImage: macOS-latest
    variables:
      pythonVersion: '3.7'
      cmakeBuildType: Release

    steps:
    # Use a specific Python version
    - task: UsePythonVersion@0
      displayName: Use Python $(pythonVersion)
      inputs:
        versionSpec: $(pythonVersion)
        addToPath: true
        architecture: 'x64'

    - bash: |
        git submodule update --init
        python -m pip install --user -r ext/gudhi-deploy/build-requirements.txt
        python -m pip install --user -r ext/gudhi-deploy/test-requirements.txt
        python -m pip uninstall -y pykeops
        brew update || true
        brew install ninja graphviz doxygen boost eigen gmp mpfr tbb cgal || true
      displayName: 'Install build dependencies'
    - bash: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE:STRING=$(cmakeBuildType) -GNinja -DWITH_GUDHI_EXAMPLE=ON -DWITH_GUDHI_TEST=ON -DWITH_GUDHI_UTILITIES=ON -DWITH_GUDHI_PYTHON=ON -DWITH_GUDHI_REMOTE_TEST=ON ..
        ninja
        ninja doxygen
        ctest --output-on-failure
      displayName: 'Build, test and documentation generation'

  - job: 'Windows'
    displayName: "Build and test Windows"
    timeoutInMinutes: 0
    cancelTimeoutInMinutes: 60
    pool:
      vmImage: windows-latest
    variables:
      pythonVersion: '3.8'
      cmakeConanFlags: -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake
      cmakeFlags: -DWITH_GUDHI_EXAMPLE=ON -DWITH_GUDHI_TEST=ON -DWITH_GUDHI_UTILITIES=ON -DWITH_GUDHI_PYTHON=OFF

    steps:
    # Use a specific Python version
    - task: UsePythonVersion@0
      displayName: Use Python $(pythonVersion)
      inputs:
        versionSpec: $(pythonVersion)
        addToPath: true
        architecture: 'x64'

    - script: |
        git submodule update --init
        python -m pip install --user -r ext/gudhi-deploy/build-requirements.txt
        # No PyKeOps on windows, let's workaround this one.
        for /F "tokens=*" %%A in (ext\gudhi-deploy\test-requirements.txt) do python -m pip install  %%A
        python -m pip install --user conan
      displayName: 'Install build dependencies'
    - script: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        conan profile detect
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        conan install . --output-folder=build --build=missing
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        cd build
        call conanbuild.bat
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        cmake -DCMAKE_BUILD_TYPE=Release -G "Visual Studio 17 2022" -DFORCE_EIGEN_DEFAULT_DENSE_INDEX_TYPE_TO_INT=ON $(cmakeConanFlags) $(cmakeFlags) ..
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        MSBuild GUDHIdev.sln /m /p:Configuration=Release /p:Platform=x64
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        ctest --output-on-failure -C Release -E diff_files
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        cmake  -DWITH_GUDHI_PYTHON=ON -DWITH_GUDHI_REMOTE_TEST=ON .
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        cd src\python
        # Needs to copy dll or try delvewheel ?
        python setup.py build_ext --inplace
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        SET PYTHONPATH=%CD%;%PYTHONPATH%
        echo %PYTHONPATH%
        ctest --output-on-failure -C Release
        IF %errorlevel% NEQ 0 exit /b %errorlevel%
        deactivate_conanbuild.bat
      displayName: 'Build and test'
