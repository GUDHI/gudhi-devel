jobs:
  
  - job: 'Test'
    displayName: "Build and test"
    timeoutInMinutes: 0
    cancelTimeoutInMinutes: 60
    pool:
      vmImage: macOS-10.15
    # Run the pipeline with multiple Python versions - Thanks to https://github.com/fastai/fastai
    strategy:
      matrix:
        Python36:
          python.version: '3.6'
          cmakeBuildType: Release
        Python37:
          python.version: '3.7'
          cmakeBuildType: Release
      # Increase the maxParallel value to simultaneously run the job for all versions in the matrix (max 10 for free open-source)
      maxParallel: 4
  
    steps:
      # Set the UsePythonVersion task to reference the matrix variable for its Python version
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(python.version)'
        architecture: 'x64'

    - script: sudo install -d -m 0777 /usr/local/miniconda/envs/
      displayName: Fix Conda permissions

      # Conda setup environment.
      # https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/package/conda-environment?view=vsts
      #
    - task: CondaEnvironment@0
      inputs:
        environmentName: 'gudhi_build_env'
        packageSpecs: 'python=$(python.version)'

    - script: |
        conda activate gudhi_build_env
        conda install -y conda
        conda install -y pip setuptools
        conda install -y -c conda-forge doxygen cgal-cpp>=5.0.1
        python -m pip install --user -r .github/build-requirements.txt
        python -m pip install --user -r .github/test-requirements.txt
      displayName: 'Install build dependencies'

    - script: |
        source activate gudhi_build_env
        git submodule update --init
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE:STRING=$(cmakeBuildType) -DWITH_GUDHI_TEST=ON -DWITH_GUDHI_UTILITIES=ON -DWITH_GUDHI_PYTHON=ON -DPython_ADDITIONAL_VERSIONS=3 ..
        make -j 4
        make doxygen
        ctest -j 4 --output-on-failure -E sphinx # remove sphinx build as it fails
      displayName: 'Build, test and documentation generation'
