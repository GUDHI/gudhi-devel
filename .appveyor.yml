# Specify version format
version: "{build}"

image:
  - Visual Studio 2017

platform:
  - x64

# specify custom environment variables
environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true

# build configuration, i.e. Debug, Release, etc.
configuration:
  - Debug
  - Release

# scripts that are called at very beginning, before repo cloning
init:
  - cmd: cmake --version
  - cmd: msbuild /version

# scripts that run after cloning repository
install:
  #------------------
  # Windows 10
  #------------------
  # update vcpkg
  - cmd: cd C:\tools\vcpkg
  - cmd: git pull
  - cmd: .\bootstrap-vcpkg.bat

  - cmd: if "%platform%"=="Win32" set VCPKG_ARCH=x86-windows
  - cmd: if "%platform%"=="x64"   set VCPKG_ARCH=x64-windows

  # remove outdated versions
  - cmd: vcpkg remove --outdated --recurse

  # install required dependencies
  - cmd: vcpkg install --recurse --triplet %VCPKG_ARCH% zlib boost-date-time boost-program-options boost-system boost-serialization boost-thread boost-units tbb eigen3 cgal[core]

  - cmd: vcpkg integrate install
  - cmd: cd "%APPVEYOR_BUILD_FOLDER%"

# preserve contents of selected directories and files across project builds
for:
-
  matrix:
    only:
      - image: Visual Studio 2017
  cache:
    - 'C:\tools\vcpkg\installed'

build_script:
  # get VCG library
  - git clone https://github.com/GUDHI/gudhi-devel.git

  #------------------
  # Windows 10
  #------------------
  - cmd: if "%platform%"=="Win32" set CMAKE_GENERATOR=-G"Visual Studio 15 2017"
  - cmd: if "%platform%"=="x64"   set CMAKE_GENERATOR=-G"Visual Studio 15 2017 Win64"
  - cmd: mkdir build && cd build
  - cmd: cmake %CMAKE_GENERATOR% -DCMAKE_BUILD_TYPE=%Configuration% -DCMAKE_TOOLCHAIN_FILE="C:\tools\vcpkg\scripts\buildsystems\vcpkg.cmake" -DVCG_ROOT="%APPVEYOR_BUILD_FOLDER%\VCG" ..
  - cmd: cmake --build . --target ALL_BUILD --config %Configuration% -- /maxcpucount:4

test_script:
  - cmd: ctest --build-config %Configuration% -R Coxeter_triangulation_manifold_tracing_test -V
  - cmd: ctest --build-config %Configuration% --output-on-failure
